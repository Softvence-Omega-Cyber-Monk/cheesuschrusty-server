enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

enum Difficulty {
  A1
  A2
  B1
  B2
  C1
  C2
}

enum LessonType {
  READING
  WRITING
  LISTENING
  SPEAKING
}

enum SubscriptionPlan {
  FREE
  PRO
}


model User {
  id                  String            @id @default(uuid())
  email               String            @unique
  emailVerified       Boolean           @default(false)
  password            String?           // null for future social login
  name                String?
  avatar              String?
  isActive            Boolean           @default(true)
  role                Role              @default(USER)
  // Profile Settings
  nativeLang      String    @default("English")
  targetLang      String    @default("Italian")
  currentLevel    Difficulty @default(A1)

  // Gamification fields
  xp              Int       @default(0)
  currentStreak       Int               @default(0)
  longestStreak       Int               @default(0)
  lastPracticeDate    DateTime?
  totalMinutesStudied Int               @default(0)
  wordsLearned        Int               @default(0)
  lessonsCompleted    Int               @default(0)
  dailyGoalMinutes    Int               @default(20)
  timezone            String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  // Relations
  lessonProgress  UserLessonProgress[]
  flashcardProgress     FlashcardProgress[]
  notifications       UserNotification[]
  studyPlan           StudyPlan?
  subscriptions       Subscription[]
  supportTickets      SupportTicket[]

  @@map("users")
}


model Lesson {
  id          Int        @id @default(autoincrement())
  
  // METADATA (For filtering and display)
  type        LessonType // READING, LISTENING, SPEAKING, WRITING
  difficulty  Difficulty // B1, A2, etc.
  
  // THE INPUT: The exact instruction sent to the AI
  prompt      String     @db.Text // e.g., "Generate a B1 level reading passage about a restaurant..."
  
  // THE OUTPUT: The structured lesson content returned by the AI
  // Contains passage/dialogue, questions, options, and answers.
  content     Json       
  
  // STATUS
  isPublished Boolean    @default(true) // Admin approval status
  
  createdAt   DateTime   @default(now())
  
  // Relations
  userProgress UserLessonProgress[]
}


// --------------------------------------
// 3. TRACKING (Making sure content is unique)
// --------------------------------------

model UserLessonProgress {
  id          Int      @id @default(autoincrement())
  
  userId  String
  user        User     @relation(fields: [userId], references: [id])
  
  lessonId    Int
  lesson      Lesson   @relation(fields: [lessonId], references: [id])
  
  score       Int?     // e.g. 80% accuracy
  completedAt DateTime @default(now())

  @@unique([userId, lessonId]) // Prevents duplicate records for same lesson
}



// --------------------------------------
// 3. FLASHCARDS (Static Content)
// --------------------------------------

model Deck {
  id          Int       @id @default(autoincrement())
  title       String    // "Top 100 Verbs"
  description String?
  difficulty  Difficulty
  category    String    // "Grammar", "Vocabulary"
  
  cards       Card[]
  
  createdAt   DateTime  @default(now())
}

model Card {
  id          Int       @id @default(autoincrement())
  deckId      Int
  deck        Deck      @relation(fields: [deckId], references: [id])
  
  frontText   String    // "Ciao"
  backText    String    // "Hello"
  audioUrl    String?   // Optional: If you pre-generate audio for cards
  
  // Users tracking this card
  progress    FlashcardProgress[]
}

// Spaced Repetition Logic needs this table
model FlashcardProgress {
  id            Int       @id @default(autoincrement())
  userId  String
  user          User      @relation(fields: [userId], references: [id])
  cardId        Int
  card          Card      @relation(fields: [cardId], references: [id])
  
  status        String    // "New", "Learning", "Review", "Mastered"
  easeFactor    Float     @default(2.5) // For SM-2 Algorithm
  interval      Int       @default(0)   // Days until next review
  nextReview    DateTime  @default(now())

  @@unique([userId, cardId]) // One progress record per card per user
}

model StudyPlan {
  id           String    @id @default(uuid())
  userId       String    @unique
  goalMinutes  Int
  daysPerWeek  Int
  focusAreas   String[]  // ["vocabulary", "speaking", etc.]
  generatedAt  DateTime  @default(now())
  expiresAt    DateTime
  activities   Json      // AI-generated daily tasks

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("study_plans")
}

model Subscription {
  id              String   @id @default(uuid())
  userId          String
  stripeCustomerId String?
  stripeSubscriptionId String?
  plan            SubscriptionPlan
  status          String   // active, canceled, past_due, etc.
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}



model SupportTicket {
  id         String   @id @default(uuid())
  userId     String
  subject    String
  message    String
  status     String   @default("open") // open, in_progress, resolved
  priority   String   @default("medium")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("support_tickets")
}

model UserNotification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  type      String   // streak | reminder | achievement
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_notifications")
}

