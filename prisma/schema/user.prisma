// ------------------------
// ENUMS
// ------------------------

enum Role {
  USER
  CONTENT_MANAGER
  SUPORT_MANAGER
  SUPER_ADMIN
}

enum Difficulty {
  A1
  A2
  B1
  B2
  C1
  C2
}

enum LessonType {
  READING
  WRITING
  LISTENING
  SPEAKING
}

enum SubCategoryType {
  // Reading
  MAIN_PASSAGE 

  // Listening
  DIALOGUE_SEQUENCING
  DICTATION_EXERCISE
  AUDIO_COMPREHENSION

  // Writing
  GRAMMAR_PRACTICE
  COMPLETE_THE_SENTENCES
  SHORT_ESSAY

  // Speaking
  READING_ALOUD
  CONVERSATION_PRACTICE
  PRONUNCIATION_PRACTICE
}

enum SessionStatus {
  ACTIVE
  PAUSED
  FINISHED
}

enum SubscriptionPlan {
  FREE
  PRO
}

enum TicketStatus {
  OPEN
  INPROGRESS
  RESOLVED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
}

enum AIProvider {
  OPENAI
  GROK
}

// ------------------------
// USER
// ------------------------

model User {
  id            String     @id @default(uuid())
  email         String     @unique
  emailVerified Boolean    @default(false)
  password      String?
  name          String?
  avatar        String?
  isActive      Boolean    @default(true)
  hasUsedTrial  Boolean    @default(false)
  role          Role       @default(USER)

  nativeLang    String     @default("English")
  targetLang    String     @default("Italian")
  currentLevel  Difficulty @default(A1)

  xp                      Int      @default(0)
  currentStreak           Int      @default(0)
  longestStreak           Int      @default(0)
  lastPracticeDate        DateTime?
  totalMinutesStudied     Int      @default(0)
  wordsLearned            Int      @default(0)
  lessonsCompleted        Int      @default(0)
  dailyGoalMinutes        Int      @default(20)
  timezone                String?
  stripeCustomerId        String?  @unique
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Relations
  lessonProgress          UserLessonProgress[]
  flashcardProgress       FlashcardProgress[]
  notifications           UserNotification[]
  studyPlan               StudyPlan?
  subscriptions           Subscription[]
  supportTickets          SupportTicket[]
  activeFlashcardSessions ActiveFlashcardSession[] @relation("UserSessions")

  // âœ… NEW: proper inverse relation for messages
  supportMessages         SupportTicketMessage[] @relation("UserSentMessages")

  @@map("users")
}

// ------------------------
// LESSONS
// ------------------------

model Lesson {
  id          Int         @id @default(autoincrement())
  title       String
  type        LessonType
  difficulty  Difficulty
  provider    AIProvider?
  isPublished Boolean     @default(false)
  createdAt   DateTime    @default(now())

  questionSets QuestionSet[]
  userProgress UserLessonProgress[]

  @@map("lessons")
}

model QuestionSet {
  id              Int         @id @default(autoincrement())
  lessonId        Int
  lesson          Lesson      @relation(fields: [lessonId], references: [id])
  subCategoryType SubCategoryType
  prompt          String      @db.Text
  content         Json
  createdAt       DateTime    @default(now())

  @@unique([lessonId, subCategoryType])
  @@map("question_sets")
}

model UserLessonProgress {
  id          Int     @id @default(autoincrement())
  userId      String
  user        User    @relation(fields: [userId], references: [id])
  lessonId    Int
  lesson      Lesson  @relation(fields: [lessonId], references: [id])
  score       Int?
  completedAt DateTime @default(now())

  @@unique([userId, lessonId])
}

// ------------------------
// FLASHCARDS
// ------------------------

model FlashcardCategory {
  id         Int        @id @default(autoincrement())
  title      String
  difficulty Difficulty
  cards      Card[]
  createdAt  DateTime @default(now())

  @@map("flashcard_categories")
}

model Card {
  id         Int               @id @default(autoincrement())
  categoryId Int
  category   FlashcardCategory @relation(fields: [categoryId], references: [id])
  frontText  String
  backText   String
  progress   FlashcardProgress[]

  @@map("cards")
}

model FlashcardProgress {
  id                  Int      @id @default(autoincrement())
  userId              String
  user                User     @relation(fields: [userId], references: [id])
  cardId              Int
  card                Card     @relation(fields: [cardId], references: [id])
  easeFactor          Float    @default(2.5)
  interval            Int      @default(0)
  nextReview          DateTime @default(now())
  repetitions         Int      @default(0)
  totalReviews        Int      @default(0)
  totalCorrectReviews Int      @default(0)

  @@unique([userId, cardId])
  @@map("flashcard_progress")
}

model ActiveFlashcardSession {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation("UserSessions", fields: [userId], references: [id])
  categoryName  String
  status        SessionStatus @default(ACTIVE)
  sessionData   Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  dateCompleted DateTime?

  @@map("active_flashcard_sessions")
}

// ------------------------
// STUDY PLAN / SUBSCRIPTIONS
// ------------------------

model StudyPlan {
  id          String   @id @default(uuid())
  userId      String   @unique
  goalMinutes Int
  daysPerWeek Int
  focusAreas  String[]
  generatedAt DateTime @default(now())
  expiresAt   DateTime
  activities  Json
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("study_plans")
}

model Subscription {
  id                   String     @id @default(uuid())
  userId               String     @unique
  stripeCustomerId     String?
  stripeSubscriptionId String?
  planAlias            String?
  plan                 SubscriptionPlan
  status               String
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  createdAt            DateTime @default(now())
  user                 User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model Plan {
  id            Int      @id @default(autoincrement())
  alias         String   @unique
  name          String
  description   String[]
  stripePriceId String
  price         Float
  interval      String
  currency      String  @default("USD")
  isActive      Boolean @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ------------------------
// SUPPORT TICKETS
// ------------------------

model SupportTicket {
  id        String   @id @default(uuid())
  userId    String
  subject   String
  status    TicketStatus    @default(OPEN)
  priority  TicketPriority  @default(MEDIUM)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  SupportTicketMessage[]

  @@map("support_tickets")
}

model SupportTicketMessage {
  id        String   @id @default(uuid())
  ticketId  String
  ticket    SupportTicket @relation(fields: [ticketId], references: [id])

  senderId  String
  sender    User @relation("UserSentMessages", fields: [senderId], references: [id])

  message   String
  createdAt DateTime @default(now())
}

// ------------------------
// NOTIFICATIONS
// ------------------------

model UserNotification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  type      String
  read      Boolean   @default(false)
  createdAt DateTime  @default(now())

  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_notifications")
}
