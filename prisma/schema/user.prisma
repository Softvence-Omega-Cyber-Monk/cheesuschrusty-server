// ------------------------
// ENUMS
// ------------------------

enum Role {
  USER
  CONTENT_MANAGER
  SUPORT_MANAGER
  SUPER_ADMIN
}

enum Difficulty {
  A1
  A2
  B1
  B2
  C1
  C2
}

enum LessonType {
  READING
  WRITING
  LISTENING
  SPEAKING
}

enum SubCategoryType {
  // Reading
  MAIN_PASSAGE 

  // Listening
  DIALOGUE_SEQUENCING
  DICTATION_EXERCISE
  AUDIO_COMPREHENSION

  // Writing
  GRAMMAR_PRACTICE
  COMPLETE_THE_SENTENCES
  SHORT_ESSAY

  // Speaking
  READING_ALOUD
  CONVERSATION_PRACTICE
  PRONUNCIATION_PRACTICE
}

enum SessionStatus {
  ACTIVE
  PAUSED
  FINISHED
}

enum SubscriptionPlan {
  FREE
  PRO
}

enum TicketStatus {
  OPEN
  INPROGRESS
  RESOLVED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
}

enum AIProvider {
  OPENAI
  GROK
}

// ------------------------
// USER
// ------------------------
model User {
  id            String     @id @default(uuid())
  email         String     @unique
  emailVerified Boolean    @default(false)
  password      String?
  name          String?
  avatar        String?
  isActive      Boolean    @default(true)
  hasUsedTrial  Boolean    @default(false)
  role          Role       @default(USER)

  nativeLang    String     @default("English")
  targetLang    String     @default("Italian")
  currentLevel  Difficulty @default(B1)

  xp                      Int      @default(0)
  currentStreak           Int      @default(0)
  longestStreak           Int      @default(0)
  lastPracticeDate        DateTime?
  totalMinutesStudied     Int      @default(0)
  wordsLearned            Int      @default(0)
  lessonsCompleted        Int      @default(0)
  dailyGoalMinutes        Int      @default(20)
  timezone                String?
  stripeCustomerId        String?  @unique
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt


   // --- New fields for SecuritySettings ---
  failedLoginAttempts     Int      @default(0)      // Track failed login attempts
  lastLoginAt             DateTime?                     // Track last login time (for session timeout)
  lockedUntil         DateTime?

  // Relations (no onDelete here)
  lessonProgress          UserLessonProgress[]
  flashcardProgress       FlashcardProgress[]
  notifications           UserNotification[]
  studyPlan               StudyPlan?
  subscriptions           Subscription[]
  supportTickets          SupportTicket[]
  activeFlashcardSessions ActiveFlashcardSession[] @relation("UserSessions")
  supportMessages         SupportTicketMessage[]   @relation("UserSentMessages")

  @@map("users")
}

// ------------------------
// LESSONS
// ------------------------
model Lesson {
  id          Int         @id @default(autoincrement())
  title       String
  type        LessonType
  difficulty  Difficulty
  provider    AIProvider?
  isPublished Boolean     @default(false)
  createdAt   DateTime    @default(now())

  questionSets QuestionSet[]
  userProgress UserLessonProgress[]

  @@map("lessons")
}

model QuestionSet {
  id              Int         @id @default(autoincrement())
  lessonId        Int
  lesson          Lesson      @relation(fields: [lessonId], references: [id])
  subCategoryType SubCategoryType
  prompt          String      @db.Text
  content         Json
  createdAt       DateTime    @default(now())

  @@unique([lessonId, subCategoryType])
  @@map("question_sets")
}

model UserLessonProgress {
  id          Int     @id @default(autoincrement())
  userId      String
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId    Int
  lesson      Lesson  @relation(fields: [lessonId], references: [id])
  score       Int?
  completedAt DateTime @default(now())

  @@unique([userId, lessonId])
}

// ------------------------
// FLASHCARDS
// ------------------------
model FlashcardCategory {
  id         Int        @id @default(autoincrement())
  title      String
  difficulty Difficulty
  cards      Card[]
  createdAt  DateTime @default(now())

  @@map("flashcard_categories")
}

model Card {
  id         Int               @id @default(autoincrement())
  categoryId Int
  category   FlashcardCategory @relation(fields: [categoryId], references: [id])
  frontText  String
  backText   String
  progress   FlashcardProgress[]

  @@map("cards")
}

model FlashcardProgress {
  id                  Int      @id @default(autoincrement())
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cardId              Int
  card                Card     @relation(fields: [cardId], references: [id])
  easeFactor          Float    @default(2.5)
  interval            Int      @default(0)
  nextReview          DateTime @default(now())
  repetitions         Int      @default(0)
  totalReviews        Int      @default(0)
  totalCorrectReviews Int      @default(0)

  @@unique([userId, cardId])
  @@map("flashcard_progress")
}

model ActiveFlashcardSession {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation("UserSessions", fields: [userId], references: [id], onDelete: Cascade)
  categoryName  String
  status        SessionStatus @default(ACTIVE)
  sessionData   Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  dateCompleted DateTime?

  @@map("active_flashcard_sessions")
}

// ------------------------
// STUDY PLAN / SUBSCRIPTIONS
// ------------------------
model StudyPlan {
  id          String   @id @default(uuid())
  userId      String   @unique
  goalMinutes Int
  daysPerWeek Int
  focusAreas  String[]
  generatedAt DateTime @default(now())
  expiresAt   DateTime
  activities  Json
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("study_plans")
}

model Subscription {
  id                   String     @id @default(uuid())
  userId               String     @unique
  stripeCustomerId     String?
  stripeSubscriptionId String?
  planAlias            String?
  plan                 SubscriptionPlan
  status               String
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  createdAt            DateTime @default(now())
  user                 User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model Plan {
  id            Int      @id @default(autoincrement())
  alias         String   @unique
  name          String
  description   String[]
  stripePriceId String
  price         Float
  interval      String
  currency      String  @default("USD")
  isActive      Boolean @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ------------------------
// SUPPORT TICKETS
// ------------------------
model SupportTicket {
  id        String   @id @default(uuid())
  userId    String
  subject   String
  status    TicketStatus    @default(OPEN)
  priority  TicketPriority  @default(MEDIUM)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  SupportTicketMessage[]

  @@map("support_tickets")
}

model SupportTicketMessage {
  id        String   @id @default(uuid())
  ticketId  String
  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  senderId  String
  sender    User @relation("UserSentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  message   String
  createdAt DateTime @default(now())
}

// ------------------------
// NOTIFICATIONS
// ------------------------
model UserNotification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  type      String
  read      Boolean   @default(false)
  createdAt DateTime  @default(now())

  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_notifications")
}








//settings
model BrandingSettings {
  id              Int      @id @default(1)
  platformLogoUrl String?
  faviconUrl      String?
  
  primaryColor    String   @default("#003213")
  secondaryColor  String   @default("#3F83F5")
  accentColor     String   @default("#0e0ebf")

  headingFont     String   @default("Inter")
  bodyFont        String   @default("Inter")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("branding_settings")
}




model SecuritySettings {
  id                        Int      @id @default(1)

  // Password Policy
  minPasswordLength         Int      @default(8)
  passwordExpiryDays        Int      @default(90)
  requireSpecialChars       Boolean  @default(true)
  requireUppercaseLetters   Boolean  @default(true)

  // Session Management
  sessionTimeoutDays        Int      @default(3) 
  maxLoginAttempts          Int      @default(5)

  // Data Privacy
  dataRetentionPolicy       Boolean  @default(true)
  dataRetentionDays         Int      @default(365)
  gdprComplianceMode        Boolean  @default(false)

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@map("security_settings")
}



model PlatformSettings {
  id                  Int      @id @default(1)

  platformName        String   @default("ItalianMaster")
  platformTitle       String?
  platformDescription String?  @db.Text

  defaultLanguage     String   @default("English")
  defaultTimezone     String   @default("Europe/Rome")

  // Feature toggles
  allowNewRegistration Boolean @default(true)
  
  freeTrialEnabled     Boolean @default(true)   // <--- NEW (toggle)
  freeTrialPeriodDays  Int     @default(7)      // <--- number field

  maintenanceMode      Boolean @default(false)

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@map("platform_settings")
}
