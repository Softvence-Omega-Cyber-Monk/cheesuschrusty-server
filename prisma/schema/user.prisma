enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

enum SubscriptionPlan {
  FREE
  PRO
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

model User {
  id                  String            @id @default(uuid())
  email               String            @unique
  emailVerified       Boolean           @default(false)
  password            String?           // null for future social login
  name                String?
  avatar              String?
  gender              Gender?
  isActive            Boolean           @default(true)
  role                Role              @default(USER)
  subscriptionPlan    SubscriptionPlan  @default(FREE)
  proExpiresAt        DateTime?         // null = never had Pro or expired
  currentStreak       Int               @default(0)
  longestStreak       Int               @default(0)
  lastPracticeDate    DateTime?
  totalMinutesStudied Int               @default(0)
  wordsLearned        Int               @default(0)
  lessonsCompleted    Int               @default(0)
  targetLanguage      String            @default("Italian")
  nativeLanguage      String            @default("English")
  dailyGoalMinutes    Int               @default(20)
  timezone            String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // Relations
  progress            SkillProgress[]
  flashcardReviews    FlashcardReview[]
  practiceSessions    PracticeSession[]
  notifications       UserNotification[]
  studyPlan           StudyPlan?
  aiUsage             AiUsage[]
  subscriptions       Subscription[]
  supportTickets      SupportTicket[]

  @@map("users")
}

model SkillProgress {
  id           String   @id @default(uuid())
  userId       String
  skill        String   // "reading" | "listening" | "writing" | "speaking"
  level        String   // e.g., "B1", "B1+", "B2"
  score        Int      // 0–100
  totalXp      Int      @default(0)
  exercisesDone Int     @default(0)
  updatedAt    DateTime @updatedAt

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, skill])
  @@map("skill_progress")
}

model PracticeSession {
  id           String   @id @default(uuid())
  userId       String
  skill        String
  startedAt    DateTime
  endedAt      DateTime?
  duration     Int?     // minutes
  exercises    Int
  correct      Int
  score        Float?
  aiGenerated  Boolean  @default(true)
  createdAt    DateTime @default(now())

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("practice_sessions")
}

model Flashcard {
  id           String   @id @default(uuid())
  front        String
  back         String
  deckId       String
  difficulty   String   // "beginner" | "intermediate" | "advanced"
  category     String?
  createdAt    DateTime @default(now())

  deck         FlashcardDeck @relation(fields: [deckId], references: [id])
  reviews      FlashcardReview[]

  @@map("flashcards")
}

model FlashcardDeck {
  id           String       @id @default(uuid())
  title        String
  description  String?
  status       String       @default("draft") // draft | published
  difficulty   String
  category     String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  flashcards   Flashcard[]

  @@map("flashcard_decks")
}

model FlashcardReview {
  id            String   @id @default(uuid())
  userId        String
  flashcardId   String
  easeFactor    Float    @default(2.5)
  interval      Int      @default(1)    // days
  repetitions   Int      @default(0)
  nextReviewAt  DateTime
  quality       Int      // 0–5 (Anki style)
  reviewedAt    DateTime @default(now())

  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  flashcard     Flashcard    @relation(fields: [flashcardId], references: [id], onDelete: Cascade)

  @@map("flashcard_reviews")
}

model StudyPlan {
  id           String    @id @default(uuid())
  userId       String    @unique
  goalMinutes  Int
  daysPerWeek  Int
  focusAreas   String[]  // ["vocabulary", "speaking", etc.]
  generatedAt  DateTime  @default(now())
  expiresAt    DateTime
  activities   Json      // AI-generated daily tasks

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("study_plans")
}

model Subscription {
  id              String   @id @default(uuid())
  userId          String
  stripeCustomerId String?
  stripeSubscriptionId String?
  plan            SubscriptionPlan
  status          String   // active, canceled, past_due, etc.
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model AiUsage {
  id         String   @id @default(uuid())
  userId     String
  date       DateTime @default(now()) @db.Date
  generations Int     @default(0)
  tokensUsed  Int     @default(0)

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@map("ai_usage")
}

model SupportTicket {
  id         String   @id @default(uuid())
  userId     String
  subject    String
  message    String
  status     String   @default("open") // open, in_progress, resolved
  priority   String   @default("medium")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("support_tickets")
}

model UserNotification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  type      String   // streak | reminder | achievement
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_notifications")
}

// Optional: For future admin settings (A/B testing prompts, etc.)
model AdminPrompt {
  id        String   @id @default(uuid())
  skill     String   // "reading_question" | "speaking_feedback" | etc.
  name      String   // e.g., "Prompt V1 – Friendly", "Prompt V2 – Strict"
  prompt    String
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_prompts")
}